import org.owasp.esapi.ESAPI;
import org.owasp.esapi.codecs.OracleCodec;
import org.owasp.esapi.errors.EncodingException;
import org.springframework.stereotype.Component;
import java.util.regex.Pattern;

@Component
public class Sanitizer {

    // Oracle SQL whitelist pattern (preserves comments/spaces)
    private static final String ORACLE_SQL_PATTERN = 
        "^[a-zA-Z0-9_\\s\\/.,:;()@=+\\-\\\\\"'’]$";

    static {
        // Initialize ESAPI validation rule for SQL
        ESAPI.validator().addRule("OracleSQL", 
            new RegexValidationRule("OracleSQL", 
                Pattern.compile(ORACLE_SQL_PATTERN, Pattern.CASE_INSENSITIVE)
            )
        );
    }

    public String sql(String input) {
        try {
            // Step 1: Decode nested encodings
            String canonical = ESAPI.encoder().canonicalize(input);
            
            // Step 2: Validate against Oracle-safe pattern
            if (!ESAPI.validator().isValidInput("SQL", canonical, "OracleSQL", 10000)) {
                throw new SecurityException("Invalid SQL characters detected");
            }
            
            // Step 3: Oracle-specific escaping
            return ESAPI.encoder().encodeForSQL(
                new OracleCodec(), 
                canonical
            );
            
        } catch (EncodingException e) {
            throw new SecurityException("SQL sanitization failed", e);
        }
    }

    public String ldap(String input) {
        try {
            // Step 1: Decode nested encodings
            String canonical = ESAPI.encoder().canonicalize(input);
            
            // Step 2: Apply LDAP-specific escaping
            return ESAPI.encoder().encodeForLDAP(canonical);
            
        } catch (EncodingException e) {
            throw new SecurityException("LDAP sanitization failed", e);
        }
    }
}


ESAPI.properties

# ESAPI Configuration
ESAPI.Logger=org.owasp.esapi.logging.slf4j.Slf4JLogFactory
Encoder.AllowMixedEncoding=false
Validator.Configuration=validation.properties


validation.properties
# SQL Validation
Validator.OracleSQL=^[a-zA-Z0-9_\\s\\/.,:;()@=+\\-\\\\\"'’]$


implementation 'org.owasp.esapi:esapi:2.5.2.0'
